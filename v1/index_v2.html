<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Decryptor - Masuk</title>
  <style>
    body{font-family:sans-serif;background:#111;color:#eee;margin:0;padding:24px;text-align:center}
    h1{margin-bottom:20px}
    input,button{padding:12px;font-size:16px;border-radius:8px;margin:6px 0;width:90%;max-width:340px;border:1px solid #444}
    button{background:#3b82f6;color:#fff;border:none;cursor:pointer}
    button:hover{background:#2563eb}
    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#1f2937;border:1px solid #374151;border-radius:14px;max-width:420px;width:90%;padding:18px;text-align:center}
    .modal h2{margin:6px 0 12px}
    .modal .row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .modal button{width:auto;min-width:160px}
    .muted{opacity:.8;font-size:.9rem}
  </style>
</head>
<body>
  <h1>Decrypto Game - ðŸ”‘ Masuk Game Room</h1>
  <input id="gameId" placeholder="Game ID (4 digit)" inputmode="numeric" maxlength="4"/>
  <br/>
  <input id="teamName" placeholder="Nama Tim (case-insensitive)"/>
  <br/>
  <input id="username" placeholder="Username (case-insensitive)"/>
  <br/>
  <button id="joinBtn">Join</button>

  <!-- Modal pilih role -->
  <div id="roleOverlay" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h2>Choose your role!</h2>
      <p class="muted">Player pertama di tim memilih role. Player kedua otomatis mendapat role sisanya.</p>
      <div class="row">
        <button id="btnSpeaker">Clue Speakers</button>
        <button id="btnHunter">Clue Hunters</button>
      </div>
      <div style="margin-top:10px">
        <button id="btnCancel" style="background:#6b7280">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
    import { db } from "./firebase.js";

    const $ = (id)=>document.getElementById(id);
    const overlay = $("roleOverlay");
    const btnSpeaker = $("btnSpeaker");
    const btnHunter = $("btnHunter");
    const btnCancel = $("btnCancel");

    $("joinBtn").addEventListener("click", start);

    function lc(s){ return (s||"").trim().toLowerCase(); }

    async function start() {
      const gameId = $("gameId").value.trim();
      const teamRaw = $("teamName").value.trim();
      const userRaw = $("username").value.trim();

      if (!/^\d{4}$/.test(gameId)) return alert("Game ID harus 4 digit angka!");
      if (!teamRaw) return alert("Isi nama tim!");
      if (!userRaw) return alert("Isi username!");

      const team = lc(teamRaw);
      const user = lc(userRaw);

      const gamePath = `games/decrypto/${gameId}`;
      const gref = ref(db, gamePath);
      const snap = await get(gref);

      // Muat wordbank
      const text = await fetch("words.txt").then(r=>r.text());
      const allWords = text.split("\n").map(w=>w.trim()).filter(Boolean);
      const shuffle = a => { const x=[...a]; for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[x[i],x[j]]=[x[j],x[i]]} return x; };

      // Helper pindah halaman dengan param user
      function go(page, gameId, team, user) {
        location.href = `${page}?gameId=${gameId}&team=${encodeURIComponent(team)}&user=${encodeURIComponent(user)}`;
      }

      // Jika game belum ada â†’ buat baru & lanjut ke pilih role
      if (!snap.exists()) {
        const selected = shuffle(allWords).slice(0,4);
        await set(gref, {
          currentRound: 1,
          winner: null,
          teamOrder: [team],
          teams: { [team]: { words: selected, ready: false, score: 0, roles: { speaker: null, hunter: null } } },
          rounds: {},
          players: {}
        });
        return showRoleChooser("new");
      }

      const game = snap.val() || {};

      // Jika game selesai â†’ reset dan buat baru
      if (game.winner) {
        await remove(gref);
        const selected = shuffle(allWords).slice(0,4);
        await set(gref, {
          currentRound: 1,
          winner: null,
          teamOrder: [team],
          teams: { [team]: { words: selected, ready: false, score: 0, roles: { speaker: null, hunter: null } } },
          rounds: {},
          players: {}
        });
        return showRoleChooser("new_after_reset");
      }

      // Jika user sudah pernah join â†’ langsung kembali ke role lama
      const player = (game.players && game.players[user]) || null;
      if (player) {
        const { team: t, role } = player;
        return go(role === "speaker" ? "codes.html" : "answers.html", gameId, t, user);
      }

      // Round >= 2 â†’ tolak tim baru (tetap mengikuti rule lama)
      if ((game.currentRound || 1) >= 2 && !(game.teams||{})[team]) {
        alert("Game sedang berlangsung!");
        return;
      }

      // Pastikan tim ada; kalau belum ada di round 1 â†’ buat tim & tambah ke teamOrder
      const teams = game.teams || {};
      if (!teams[team]) {
        const used = Object.values(teams).flatMap(t => t.words || []);
        const remaining = allWords.filter(w => !used.includes(w));
        if (remaining.length < 4) return alert("Kata tersisa tidak cukup.");
        const selected = shuffle(remaining).slice(0,4);
        const newOrder = Array.isArray(game.teamOrder) ? [...game.teamOrder, team] : [team];
        await update(ref(db), {
          [`${gamePath}/teams/${team}`]: { words: selected, ready: false, score: 0, roles: { speaker:null, hunter:null } },
          [`${gamePath}/teamOrder`]: newOrder
        });
      }

      // Ambil ulang state tim setelah mungkin dibuat
      const teamsNowSnap = await get(gref);
      const gameNow = teamsNowSnap.val();
      const roles = (gameNow.teams?.[team]?.roles) || { speaker:null, hunter:null };

      // Aturan role:
      // - Kalau dua-duanya kosong â†’ player pertama pilih role
      // - Kalau salah satu sudah terisi â†’ otomatis assign role yang tersisa
      // - Kalau dua-duanya terisi â†’ tolak
      if (!roles.speaker && !roles.hunter) {
        return showRoleChooser("first_of_team");
      } else if (roles.speaker && roles.hunter) {
        alert("Game sedang berlangsung!");
        return;
      } else {
        const autoRole = roles.speaker ? "hunter" : "speaker";
        await update(ref(db), {
          [`${gamePath}/teams/${team}/roles/${autoRole}`]: user,
          [`${gamePath}/players/${user}`]: { team, role: autoRole }
        });
        return go(autoRole === "speaker" ? "codes.html" : "answers.html", gameId, team, user);
      }

      // ==== Helpers ====
      function showRoleChooser(ctx) {
        overlay.style.display = "flex";
        btnSpeaker.onclick = async () => assignRole("speaker");
        btnHunter.onclick = async () => assignRole("hunter");
        btnCancel.onclick  = () => { overlay.style.display = "none"; /* kembali ke form */ };
        async function assignRole(role){
          overlay.style.display = "none";
          await update(ref(db), {
            [`${gamePath}/teams/${team}/roles/${role}`]: user,
            [`${gamePath}/players/${user}`]: { team, role }
          });
          go(role === "speaker" ? "codes.html" : "answers.html", gameId, team, user);
        }
      }
    }
  </script>
</body>
</html>
