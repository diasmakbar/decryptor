<body>
  <h1>Setup Game</h1>
  <input id="gameId" placeholder="Game ID (4 digit)"/>
  <br/>
  <input id="teamName" placeholder="Nama Tim (unik)"/>
  <br/>
  <button onclick="start()">Join Game</button>

  <script type="module">
    import { ref, set, get, child } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
    import { db } from "./firebase.js";

    async function start() {
      const gameId = document.getElementById("gameId").value.trim();
      const team = document.getElementById("teamName").value.trim();

      if (!/^\d{4}$/.test(gameId)) {
        alert("Game ID harus 4 digit angka!");
        return;
      }
      if (!team) {
        alert("Isi nama tim!");
        return;
      }

      // ambil game data
      const gameSnap = await get(ref(db, `games/${gameId}`));
      let allWords = (await fetch("words.txt").then(r=>r.text()))
        .split("\n").map(w=>w.trim()).filter(Boolean);

      // kalau game belum ada → buat game baru
      if (!gameSnap.exists()) {
        // generate words untuk tim pertama
        const selected = allWords.sort(()=>Math.random()-0.5).slice(0,4);

        await set(ref(db, `games/${gameId}`), {
          teams: {
            [team]: { words: selected }
          },
          rounds: {}
        });

        console.log("✅ Game baru dibuat, kata untuk", team, ":", selected);
        window.location.href = `words.html?gameId=${gameId}&team=${encodeURIComponent(team)}`;
        return;
      }

      // game sudah ada → validasi nama tim
      const gameData = gameSnap.val();
      if (gameData.teams && gameData.teams[team]) {
        alert("❌ Nama tim sudah dipakai, pilih nama lain!");
        return;
      }

      // ambil kata yang sudah dipakai tim lain
      let used = [];
      Object.values(gameData.teams || {}).forEach(t => {
        used = used.concat(t.words || []);
      });
      const remaining = allWords.filter(w => !used.includes(w));

      if (remaining.length < 4) {
        alert("⚠️ Kata tidak cukup untuk tim baru!");
        return;
      }

      const selected = remaining.sort(()=>Math.random()-0.5).slice(0,4);

      // simpan kata untuk tim baru
      await set(ref(db, `games/${gameId}/teams/${team}`), {
        words: selected
      });

      console.log("✅ Tim baru join:", team, "dengan kata:", selected);
      window.location.href = `words.html?gameId=${gameId}&team=${encodeURIComponent(team)}`;
    }

    window.start = start;
  </script>
</body>
