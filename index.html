<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Decryptor - Masuk</title>
  <style>
    body{font-family:sans-serif;background:#111;color:#eee;margin:0;padding:24px;text-align:center}
    h1{margin-bottom:20px}
    input,button{padding:12px;font-size:16px;border-radius:8px;margin:6px 0;width:90%;max-width:340px;border:1px solid #444}
    button{background:#3b82f6;color:#fff;border:none;cursor:pointer}
    button:hover{background:#2563eb}
    /* Popup */
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;justify-content:center;align-items:center;z-index:1000}
    .popup{background:#222;padding:20px;border-radius:12px;text-align:center;max-width:320px}
    .popup h2{margin-bottom:16px}
    .popup button{margin:6px 0;width:100%}
    .cancelBtn{background:#ef4444}
    .cancelBtn:hover{background:#b91c1c}
  </style>
</head>
<body>
  <h1>Decryptor Game - üîë Masuk</h1>
  <input id="gameId" placeholder="Game ID (4 digit)"/>
  <br/>
  <input id="teamName" placeholder="Nama Tim"/>
  <br/>
  <input id="username" placeholder="Username"/>
  <br/>
  <button id="joinBtn">Join</button>

  <!-- Popup pilih role -->
  <div class="overlay" id="roleOverlay">
    <div class="popup">
      <h2>Pilih peran kamu!</h2>
      <button id="roleSpeaker">üé§ Clue Speaker</button>
      <button id="roleHunter">üéØ Clue Hunter</button>
      <button id="roleCancel" class="cancelBtn">‚ùå Batal</button>
    </div>
  </div>

  <script type="module">
    import { ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
    import { db } from "./firebase.js";

    const joinBtn=document.getElementById("joinBtn");
    const overlay=document.getElementById("roleOverlay");
    const btnSpeaker=document.getElementById("roleSpeaker");
    const btnHunter=document.getElementById("roleHunter");
    const btnCancel=document.getElementById("roleCancel");

    let gameId, team, username, allWords, gamePath, gameRef, snap, game;

    joinBtn.addEventListener("click", start);

    async function start() {
      gameId=document.getElementById("gameId").value.trim();
      const teamRaw=(document.getElementById("teamName").value||"").trim();
      username=(document.getElementById("username").value||"").trim().toLowerCase();

      if(!/^\d{4}$/.test(gameId)) return alert("Game ID harus 4 digit angka!");
      if(!teamRaw) return alert("Isi nama tim!");
      if(!username) return alert("Isi username!");

      team=teamRaw.toLowerCase();
      gamePath=`games/decrypto/${gameId}`;
      gameRef=ref(db,gamePath);
      snap=await get(gameRef);

      // load wordbank
      const text=await fetch("words.txt").then(r=>r.text());
      allWords=text.split("\n").map(w=>w.trim()).filter(Boolean);

      const shuffle=a=>{const x=[...a];for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[x[i],x[j]]=[x[j],x[i]]}return x;};

      // case 1: game belum ada ‚Üí buat baru
      if(!snap.exists()){
        const selected=shuffle(allWords).slice(0,4);
        await set(gameRef,{
          currentRound:1,
          winner:null,
          teamOrder:[team],
          teams:{[team]:{words:selected,ready:false,score:0,hasGenerator:false}},
          players:{[username]:{team,role:null}}, // role dipilih via popup
          rounds:{}
        });
        return showRolePopup();
      }

      game=snap.val()||{};

      // case 2: game sudah selesai ‚Üí reset & buat baru
      if(game.winner){
        await remove(gameRef);
        const selected=shuffle(allWords).slice(0,4);
        await set(gameRef,{
          currentRound:1,
          winner:null,
          teamOrder:[team],
          teams:{[team]:{words:selected,ready:false,score:0,hasGenerator:false}},
          players:{[username]:{team,role:null}},
          rounds:{}
        });
        return showRolePopup();
      }

      // case 3: game sedang berlangsung (round >=2) ‚Üí tolak
      if((game.currentRound||1)>=2){
        alert("Game sedang berlangsung!");
        return;
      }

      // case 4: round masih 1 ‚Üí boleh tim baru join
      const teams=game.teams||{};
      if(!teams[team]){
        const used=Object.values(teams).flatMap(t=>t.words||[]);
        const remaining=allWords.filter(w=>!used.includes(w));
        if(remaining.length<4) return alert("Kata tersisa tidak cukup.");
        const selected=shuffle(remaining).slice(0,4);
        const newOrder=Array.isArray(game.teamOrder)?[...game.teamOrder,team]:[team];
        await update(ref(db),{
          [`${gamePath}/teams/${team}`]:{words:selected,ready:false,score:0,hasGenerator:false},
          [`${gamePath}/teamOrder`]:newOrder,
          [`${gamePath}/players/${username}`]:{team,role:null}
        });
        return showRolePopup();
      }

      // case 5: tim sudah ada ‚Üí join role
      if(game.players && game.players[username]){
        const role=game.players[username].role;
        if(!role) return showRolePopup();
        return go(role==="code"?"codes.html":"answers.html");
      }

      // cek jumlah player dalam tim ini
      const existingPlayers=Object.values(game.players||{}).filter(p=>p.team===team);
      if(existingPlayers.length===0){
        await update(ref(db),{[`${gamePath}/players/${username}`]:{team,role:null}});
        return showRolePopup();
      } else if(existingPlayers.length===1){
        // player kedua ‚Üí role otomatis
        const otherRole=existingPlayers[0].role==="code"?"answer":"code";
        await update(ref(db),{
          [`${gamePath}/players/${username}`]:{team,role:otherRole},
          ...(otherRole==="code"?{[`${gamePath}/teams/${team}/hasGenerator`]:true}:{})
        });
        return go(otherRole==="code"?"codes.html":"answers.html");
      } else {
        alert("Tim sudah penuh!");
        return;
      }
    }

    // === Popup functions ===
    function showRolePopup(){
      overlay.style.display="flex";
    }
    btnSpeaker.addEventListener("click",()=>chooseRole("code"));
    btnHunter.addEventListener("click",()=>chooseRole("answer"));
    btnCancel.addEventListener("click",()=>{overlay.style.display="none";window.location.href="index.html";});

    async function chooseRole(role){
      await update(ref(db),{
        [`${gamePath}/players/${username}/role`]:role,
        ...(role==="code"?{[`${gamePath}/teams/${team}/hasGenerator`]:true}:{})
      });
      go(role==="code"?"codes.html":"answers.html");
    }

    function go(page){
      window.location.href=`${page}?gameId=${gameId}&team=${encodeURIComponent(team)}&user=${encodeURIComponent(username)}`;
    }
  </script>
</body>
</html>
