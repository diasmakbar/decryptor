<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Decryptor - Generator</title>
  <style>
    body{font-family:sans-serif;background:#111;color:#eee;margin:0;padding:24px;text-align:center}
    h1{margin:10px 0}
    .card{background:#1f2937;border:1px solid #374151;border-radius:12px;padding:14px;margin:12px auto;max-width:420px}
    .word{background:#333;padding:8px;border-radius:8px;margin:6px 0;font-weight:700}
    button{padding:12px 16px;border:none;border-radius:10px;font-size:16px;margin:6px}
    #genBtn{background:#22c55e;color:#111}
    #readyBtn{background:#3b82f6;color:#fff}
    #code{font-size:36px;font-weight:800;letter-spacing:.25em;margin:14px 0}
    .status{opacity:.9;margin-top:12px}
  </style>
</head>
<body>
  <h1 id="hdr">Round</h1>
  <div id="wordBox" class="card">Loading kata…</div>
  <div id="code">— — —</div>
  <div>
    <button id="genBtn">Generate Code</button>
    <button id="readyBtn" disabled>Ready for Next Round</button>
  </div>
  <div id="readyState" class="status"></div>

  <script type="module">
    import { onValue, set, get, update } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
    import { db } from "./firebase.js";
    import {
      currentRoundRef, teamsRef, codeRef, teamOrderRef, teamRef,
      getHostTeam, generateUniqueCode,
      setBtnEnabled, renderReadyStatus, advanceRoundAndResetReady,
      mountWinnerBanner
    } from "./game-utils.js";
    import { maybeScoreCurrentRound } from "./scoring.js";

    const params = new URLSearchParams(window.location.search);
    const gameId = params.get("gameId");
    const myTeam = params.get("team");

    mountWinnerBanner(gameId);

    let currentRound = 1;
    let teamOrder = [];

    const hdr = document.getElementById("hdr");
    const codeBox = document.getElementById("code");
    const genBtn = document.getElementById("genBtn");
    const readyBtn = document.getElementById("readyBtn");
    const readyState = document.getElementById("readyState");

    // tampilkan kata tim
    const wordBox = document.getElementById("wordBox");
    const snap = await get(teamRef(gameId, myTeam));
    if (snap.exists()) {
      const { words = [] } = snap.val() || {};
      wordBox.innerHTML = words.map((w,i)=>`<div class="word">${i+1}. ${w}</div>`).join("");
    } else {
      wordBox.textContent = "Kata tim tidak ditemukan.";
    }

    // listen teamOrder
    onValue(teamOrderRef(gameId), (snap) => {
      teamOrder = snap.val() || teamOrder;
      updateRoleUI();
    });

    // listen round
    onValue(currentRoundRef(gameId), (snap) => {
      if (!snap.exists()) return;
      currentRound = snap.val();
      hdr.textContent = `Round ${currentRound}`;
      codeBox.textContent = "— — —";
      updateRoleUI();
    });

    // listen code untuk ronde ini
    function attachCodeListener() {
      onValue(codeRef(gameId, currentRound), (snap) => {
        if (snap.exists()) {
          codeBox.textContent = snap.val().join(" - ");
          setBtnEnabled(readyBtn, true);
        } else {
          codeBox.textContent = "— — —";
          setBtnEnabled(readyBtn, false);
        }
        maybeScoreCurrentRound(gameId);
      });
    }
    attachCodeListener();

    // listen ready states
    onValue(teamsRef(gameId), async (snap) => {
      const teamsObj = snap.val() || {};
      renderReadyStatus(readyState, teamsObj);
      const allReady = Object.values(teamsObj).length >= 2 && Object.values(teamsObj).every(t => t.ready);
      if (allReady) {
        await advanceRoundAndResetReady(gameId, currentRound + 1, teamsObj);
      }
    });

    function updateRoleUI() {
      const host = getHostTeam(teamOrder, currentRound);
      const isHost = host && myTeam === host;
      setBtnEnabled(genBtn, isHost);
      if (!isHost) {
        setBtnEnabled(readyBtn, false); // non-host tunggu host generate
      }
    }

    genBtn.addEventListener("click", async () => {
      const code = generateUniqueCode();
      await set(codeRef(gameId, currentRound), code);
      setBtnEnabled(genBtn, false);
    });

    readyBtn.addEventListener("click", async () => {
      await update(teamRef(gameId, myTeam), { ready: true });
    });
  </script>
</body>
</html>
