<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Decryptor - Clue Speaker</title>
  <style>
    body{font-family:sans-serif;background:#111;color:#eee;margin:0;padding:24px;text-align:center}
    h1{margin:10px 0}
    .wordGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;max-width:800px;margin:0 auto}
    .word{background:#2563eb;color:#fff;font-weight:800;font-size:18px;padding:14px;border-radius:10px;text-align:center}
    @media(max-width:600px){.wordGrid{grid-template-columns:repeat(2,1fr)}}
    button{padding:12px 16px;border:none;border-radius:10px;font-size:16px;margin:6px}
    #genBtn{background:#22c55e;color:#111}
    #timerBtn{background:#facc15;color:#111}
    #readyBtn{background:#3b82f6;color:#fff}
    #code{font-size:36px;font-weight:800;letter-spacing:.25em;margin:14px 0}
    .scoreBoard{background:#222;padding:10px;border-radius:10px;max-width:520px;margin:10px auto}
  </style>
</head>
<body>
  <h1 id="hdr">Round</h1>

  <div id="wordBox" class="wordGrid">Loading kata…</div>
  <div id="code">— — —</div>
  <div>
    <button id="genBtn">Generate Code</button>
    <button id="timerBtn" disabled>Start Timer</button>
    <button id="readyBtn" disabled>Ready for Next Round</button>
  </div>
  <div id="scoreBox" class="scoreBoard">Scoreboard: loading…</div>

  <script type="module">
    import { onValue, set, get, update } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
    import { db } from "./firebase.js";
    import {
      currentRoundRef, codeRef, teamRef, gameRef,
      generateUniqueCode, setBtnEnabled
    } from "./game-utils.js";
    import { maybeScoreCurrentRound } from "./scoring.js";

    const params = new URLSearchParams(window.location.search);
    const gameId = params.get("gameId");
    const myTeam = params.get("team");
    const user = params.get("user");

    const hdr=document.getElementById("hdr");
    const codeBox=document.getElementById("code");
    const genBtn=document.getElementById("genBtn");
    const timerBtn=document.getElementById("timerBtn");
    const readyBtn=document.getElementById("readyBtn");
    const scoreBox=document.getElementById("scoreBox");
    const wordBox=document.getElementById("wordBox");

    let currentRound=1;

    // Pastikan user ini role-nya code
    const pSnap = await get(ref(db,`games/decrypto/${gameId}/players/${user}`));
    if(!pSnap.exists() || pSnap.val().role!=="code"){
      alert("Kamu bukan Clue Speaker di game ini!");
      window.location.href="index.html";
    }

    // tampilkan kata tim
    const wSnap=await get(teamRef(gameId,myTeam));
    if(wSnap.exists()){
      const {words=[]}=wSnap.val();
      wordBox.innerHTML=words.map((w,i)=>`<div class="word">${w}<br/><small>${i+1}</small></div>`).join("");
    }

    // scoreboard live
    onValue(gameRef(gameId),(snap)=>{
      if(!snap.exists())return;
      const teams=snap.val().teams||{};
      scoreBox.textContent="Scoreboard → "+Object.entries(teams).map(([t,v])=>
        `${t}: ${v?.score??0}${v?.eliminated?" ❌":""}`).join(" | ");
    });

    onValue(currentRoundRef(gameId),(snap)=>{
      if(!snap.exists())return;
      currentRound=snap.val();
      hdr.textContent=`Round ${currentRound}`;
      codeBox.textContent="— — —";
      setBtnEnabled(genBtn,true);
      setBtnEnabled(timerBtn,false);
      setBtnEnabled(readyBtn,false);
    });

    genBtn.addEventListener("click",async()=>{
      const code=generateUniqueCode();
      await set(codeRef(gameId,currentRound),code);
      codeBox.textContent=code.join(" - ");
      setBtnEnabled(genBtn,false);
      setBtnEnabled(timerBtn,true);
    });

    timerBtn.addEventListener("click",async()=>{
      await update(codeRef(gameId,currentRound).parent,{timerStart:Date.now()});
      setBtnEnabled(timerBtn,false);
    });

    readyBtn.addEventListener("click",async()=>{
      await update(teamRef(gameId,myTeam),{ready:true});
    });
  </script>
</body>
</html>
