<body>
  <h1 id="roundTitle"></h1>
  <form id="answerForm">
    <div>
      <input placeholder="Clue 1" name="clue1"/>
      <input placeholder="Tebakan Angka" name="guess1" type="number"/>
      <input placeholder="Jawaban Asli" id="ans1" readonly/>
    </div>
    <div>
      <input placeholder="Clue 2" name="clue2"/>
      <input placeholder="Tebakan Angka" name="guess2" type="number"/>
      <input placeholder="Jawaban Asli" id="ans2" readonly/>
    </div>
    <div>
      <input placeholder="Clue 3" name="clue3"/>
      <input placeholder="Tebakan Angka" name="guess3" type="number"/>
      <input placeholder="Jawaban Asli" id="ans3" readonly/>
    </div>
    <button type="submit">Submit</button>
  </form>

  <h2>History</h2>
  <div id="historyBox"></div>

  <script type="module">
    import { ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
    import { db } from "./firebase.js";

    const params = new URLSearchParams(window.location.search);
    const gameId = params.get("gameId") || "test";
    const team = params.get("team") || "Unknown";

    let round = 1;
    document.getElementById("roundTitle").textContent = `Team ${team} - Round ${round}`;

    // ðŸ”¹ listen kode resmi dari generator
    onValue(ref(db, `games/${gameId}/rounds/${round}/code`), snap => {
      if (snap.exists()) {
        const code = snap.val();
        document.getElementById("ans1").value = code[0];
        document.getElementById("ans2").value = code[1];
        document.getElementById("ans3").value = code[2];
      }
    });

    // ðŸ”¹ submit clue & guesses
    document.getElementById("answerForm").addEventListener("submit", async e => {
      e.preventDefault();
      const data = new FormData(e.target);
      const clues = [data.get("clue1"), data.get("clue2"), data.get("clue3")];
      const guesses = [data.get("guess1"), data.get("guess2"), data.get("guess3")];

      // validasi angka
      if (!guesses.every(g => g && /^[1-4]$/.test(g))) {
        alert("Tebakan harus angka 1â€“4!");
        return;
      }

      await set(ref(db, `games/${gameId}/rounds/${round}/clues/${team}`), clues);
      await set(ref(db, `games/${gameId}/rounds/${round}/guesses/${team}`), guesses);

      round++;
      document.getElementById("roundTitle").textContent = `Team ${team} - Round ${round}`;
      e.target.reset();
    });

    // ðŸ”¹ render history realtime
    onValue(ref(db, `games/${gameId}/rounds`), snap => {
      if (snap.exists()) {
        const rounds = snap.val();
        const div = document.getElementById("historyBox");
        div.innerHTML = "";

        Object.entries(rounds).forEach(([num,data]) => {
          div.innerHTML += `
            <div style="margin-bottom:15px; text-align:left;">
              <b>Round ${num}</b><br/>
              <u>Code:</u> ${data.code ? data.code.join(" - ") : "-"}<br/><br/>

              <b>Team A</b><br/>
              Clues: ${data.clues?.TeamA ? data.clues.TeamA.join(" | ") : "-"}<br/>
              Guesses: ${data.guesses?.TeamA ? data.guesses.TeamA.join(" - ") : "-"}<br/><br/>

              <b>Team B</b><br/>
              Clues: ${data.clues?.TeamB ? data.clues.TeamB.join(" | ") : "-"}<br/>
              Guesses: ${data.guesses?.TeamB ? data.guesses.TeamB.join(" - ") : "-"}<br/>
            </div><hr/>`;
        });
      }
    });
  </script>
</body>
